name: Create and Publish Docker Image
description: Build docker image and kubectl manifest
inputs:
  image_name:
    description: Name of image to build, and name used in pod
    required: true
  context:
    description: context 
    required: true
  kustomize_dir:
    description: Directory containing kustomization.yaml, kustomize sets the new image tag.
    required: true
runs:
  using: "composite"
  steps:
    - name: Docker meta
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: europe-west1-docker.pkg.dev/niva-cd/images/${{ inputs.image_name }}
        tags: |
          type=sha,prefix=
          type=raw,value=latest

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    - id: docker_push
      name: Build and push
      uses: docker/build-push-action@v4
      with:
        push: true
        context: ${{ inputs.context }}
        tags: ${{ steps.meta.outputs.tags }}
        cache-from: type=registry,ref=europe-west1-docker.pkg.dev/niva-cd/images/${{ inputs.image_name }}:latest
        cache-to: type=inline
        build-args: | 
          GIT_SHA=${{ github.sha }}
    - name: Bump deployment image
      shell: bash
      run: |
        cd ${{inputs.kustomize_dir}}

        kustomize edit set image *${{ inputs.image_name }}*=europe-west1-docker.pkg.dev/niva-cd/images/${{inputs.image_name}}:${GITHUB_SHA::7}